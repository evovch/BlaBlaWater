\subsection{Адаптация CbmRoot для работы с GDML}\label{sec:secFairModule}

Целевым пакетом для большинста MC-моделей, разработанных с помощью ``CATIA-GDML geometry builder'', в частности CBM RICH, является пакет CbmRoot, в котором выполняется моделирование, реконструкция, приём и анализ данных эксперимента CBM.
CbmRoot является фреймворком, написанным на основе FairRoot, который в свою очередь написан на основе ROOT.
Это означает, что многие классы CbmRoot унаследованы от классов FairRoot, а многие из классов FairRoot --- от классов ROOT.
Также ``Builder'' применялся для подсистем других экспериментов FAIR (см. секцию~\ref{sec:secBuilderOtherUsage}), в которых используются схожие FairRoot-наследованные пакеты PandaRoot и R3bRoot.
Методы классов могут быть имплементированы (реализованы, т.е. их код написан) на различных уровнях --- как в материнском классе самого верхнего уровня, так и дочернем, или в любом промежуточном классе, если таковые имеются, причём широко используется такая возможность C++, как реализация в дочернем классе метода, объявленного в материнском классе.

% \todo запятая?
По мере развития и применения ``CATIA-GDML geometry builder'' на практике, для интеграции с целевыми системами вносились изменения в различные классы указанных пакетов.

В итоговом варианте весь функционал реализован в пакете FairRoot и необходимость в классе \classname{CbmModule} отпала.

Любой элемент экспериментальной установки в системе FairROOT описывается классом, наследованным от базового класса \classname{FairModule}.
Для импорта геометрической информации из внешнего файла в классе \classname{FairModule} предусмотрен метод \methodname{ConstructGeometry}.
Данный метод не выполняет непосредственно чтение информации, а лишь определяет тип файла и выбирает какой метод необходимо вызвать.
Поддерживаются различные форматы входных файлов, поэтому существуют отдельные методы, отвечающие за соответствующие форматы:

\begin{itemize}
\itemsep0pt
\item \methodname{ConstructROOTGeometry};
\item \methodname{ConstructASCIIGeometry};
\item \methodname{ConstructGEOGeometry};
\item \methodname{ConstructGDMLGeometry}.
\end{itemize}

Методы \methodname{ConstructASCIIGeometry} и \methodname{ConstructGEOGeometry} не имеют реализации, в то время как в методе \methodname{ConstructROOTGeometry} запрограммирован импорт геометрии из root-файла. \todo Нашими усилиями был добавлен метод \methodname{ConstructGDMLGeometry} с реализацией импорта из gdml-файлов с применением класса \classname{TGDMLParse} из ROOT.
Если требуется, чтобы элемент установки, реализованный в классе, наследованном от \classname{FairModule}, имел возможность импорта из текстового файла или geo-файла, то в этом классе должна быть реализована процедура импорта в перегруженном методе \methodname{ConstructASCIIGeometry} или, соответственно, \methodname{ConstructGEOGeometry}.


% Промежуточное решение --------------------------------------------------------------------------------------
Стоит отметить один промежуточный рабочий вариант, который реализовывал импорт геометрии из gdml-файлов изменением только исходного кода CbmRoot. В этом варианте был введён промежуточный класс \classname{CbmModule}, имеющий 2 метода --- \methodname{ConstructGDMLGeometry} и вспомогательный \methodname{ExpandNodeForGDML}, а все детекторы, которым был необходим импорт из GMDL меняли материнский класс с \classname{FairModule} на \classname{CbmModule}.

\begin{figure}[H]
\centering
\includegraphics[width=0.7\textwidth]{pictures/FairModule_classes_after.eps}
\caption{Диаграмма классов CbmROOT в промежуточном варианте на примере конкретного детектора RICH.}
\label{fig:classesAfter}
\end{figure}
% ------------------------------------------------------------------------------------------------------------


% Кусок о подсасывании описания материалов из внешнего файла -------------------------------------------------
Стандартное применение GDML подразумевает, что в файле имеется полная информация о модели, в том числе и о материалах. Это означает, что при импорте GDML файла в GEANT4 или ROOT описание материалов будет взято из секции <materials>. На практике это оказывается очень неудобным, поэтому в экспериментальных пакетах, как например в CbmRoot, по умолчанию включена опция считывания из GDML только имён материалов, игнорируя собственно описание. Однако в любом случае, для того чтобы GDML файл считался корректным с формальной точки зрения, для каждой ссылки должен существовать объект, на который эта ссылка указывает. В ``Builder'' мы используем минимальное dummy \todo описание, чтобы соблюсти правила XML файла, а фактически используется внешняя база материалов.
% ------------------------------------------------------------------------------------------------------------


% Кусок про флаг GDML при компиляции ROOT --------------------------------------------------------------------
Для работы с форматом GDML в ROOT должна быть скомпилирована соответствующая динамическая библиотека.
Эта опция может быть активирована флагом gdml при компиляции ROOT.
За установку и настройку ROOT при установке CbmRoot и других пакетов, наследованных от FairRoot, отвечает пакет FairSoft.
Поддержка GDML по умолчанию была активирована в FairSoft \todo в результате наших усилий.
В FairRoot реализованы директивы прекомпилятора, которые выводят предупреждение в случае, если эта библиотека не была активирована.
% ------------------------------------------------------------------------------------------------------------

% ============================================================================================================
%
% Далее backup
%
%

% Кусок про флаг GDML при компиляции ROOT --------------------------------------------------------------------
% Мусор
% Для работы импорта из GDML файла необходима определённая динамическая библиотека. Эта библиотека не скомпилирована по умолчанию. Если изменить исходный код FairROOT необходимо скомпилировать упомянутую библиотеку и поместить её в соответствующую папку FairROOT. По той причине, что имеется множество наследованных от FairROOT пакетов и ни один из них не скомпилирован с поддержкой GDML, изменения в исходном коде потребуют перекомпиляции всех дочерних программ, что представляет собой трудоёмкую процедуру, требующую прав администратора и значит недопустимую на данном этапе.
% ------------------------------------------------------------------------------------------------------------

% \todo -----------------------------------------------------------------

% Актуальная инфа
% На данный момент в FairRoot в классе FairModule присутствуют методы
% ConstructGDMLGeometry - вызывает parser.GDMLReadFile, ReAssignMediaId, ExpandNodeForGDML
% ConstructASCIIGeometry
% ConstructRootGeometry - с реализацией
% ConstructGeometry - пустой, нужен для реализации в дочерних классах
% ConstructOpGeometry - пустой, нужен для реализации в дочерних классах
% ModifyGeometry - ? 

% ExpandNode
% ExpandNodeForGDML

% ReAssignMediaId
% AssignMediumAtImport

% Сделан отлов ситуации, если GDML не был включён при установке.

% В CbmRoot также имеется класс CbmModule, унаследованный от FairModule с методами ConstructGDMLGeometry и ExpandNodeForGDML, по-видимому, давно не обновлявшиеся.

% CbmRich унаследован от FairDetector

% \todo -----------------------------------------------------------------


% В данной секции в качестве конкретного элемента экспериментальной установки будем рассматривать детектор RICH эксперимента CBM. Соответствующий класс имеет название \classname{CbmRich}. Всё описание с незначительными дополнениями распространяется на любой активный либо пассивный элемент установки (далее детектор).

% На \figref{fig:classesBefore} представлена диаграмма, отражающая иерархию классов и методов, касающихся импорта геометрии до внесения изменений.

%\begin{figure}[H]
%\centering
%\includegraphics[width=0.7\textwidth]{pictures/FairModule_classes_before.eps}
%\caption{Диаграмма классов CbmROOT до модификации.}
%\label{fig:classesBefore}
%\end{figure}

% Метод \methodname{ConstructGeometry} объявлен в \classname{FairModule}, но определён всегда в классе детектора. Именно этот класс определяет, какой метод вызывать в зависимости от формата входного файла. Метод \methodname{ConstructASCIIGeometry} объявлен в \classname{FairModule}, но не реализован в дочернем классе \classname{CbmRich}. Это означает, что для детектора RICH не предусмотрен импорт из текстового файла, но существует какой-то другой элемент установки, который имеет описание импорта из формата ASCII.

% Первоначально был введён метод \methodname{ConstructGDMLGeometry} на уровне класса \classname{FairModule}. Таким образом для того чтобы обеспечить вызов этого метода из класса детектора, достаточно было лишь добавить условие в методе \methodname{ConstructGeometry} в классе детектора. Автоматически вызывался бы метод из FairROOT. Такой подход был реализован и успешно проверен на локальной установке CbmRoot. Однако когда введённые изменения были внесены в промежуточный (trunk) вариант пакета в GSI было обнаружено, что возникают сложности, вызывающие некорректную работу других модулей пакета.

% Было принято решение временно перенести исходный код импорта из GDML в новый промежуточный класс \classname{CbmModule}. Затем в определённый момент, спустя годы, описываемый функционал был включён в FairRoot, что позволило использовать GDML как формат импортируемой геометрии всем унаследованным от FairRoot пакетам --- R3BRoot, PandaRoot, и т.д.

% После длительного обсуждения с разработчиками FairROOT и CbmROOT было принято решение перенести исходный код импорта из GDML в новый класс \classname{CbmModule}, что позволило внести изменения только в CbmROOT и избежать неполадок.
% Описанная процедура может быть применена к любому пакету, наследованному от FairROOT, однако на данном этапе изменения включены только в CbmROOT. Рассматривается перспектива внедрения GDML и в пакет R3BROOT.

% Добавлена ветвь условия, обеспечивающая вызов \classname{ConstructGDMLGeometry} в случае получения входного файла в формате GDML.
%\begin{lstlisting}
%void CbmRich::ConstructGeometry()
%{
%   TString fileName=GetGeometryFileName();
%   if (fileName.EndsWith(".geo")) {
%      ConstructGEOGeometry();
%   } else if (fileName.EndsWith(".root")) {
%      ConstructROOTGeometry();
%   } else if (fileName.EndsWith(".gdml")) {
%      ConstructGDMLGeometry(fposrot);
%   } else {
%      std::cout << "Geometry format not supported." << std::endl;
%   }
%}
%\end{lstlisting}

% Также для геометрии, импортированной из GDML, добавлена опциональная возможность позиционировать детектор непосредственно в макросе путём указания координат смещения и углов поворота. Данные параметры необязательны --- в случае их отсутствия детектор позиционируется по умолчанию. Для каждого элемента установки необходимо указать такие значения по умолчанию в заголовке класса. Данная процедура была выполнена для детектора RICH. Такая возможность позволяет продвинутому пользователю оперативно менять установку, а наличие значений по умолчанию ограждает неопытных пользователей от ошибок.

% Все изменения были приняты и внесены в дистрибутив CbmROOT, также как и новая геометрия CBM RICH в форматах GDML и ROOT. Решено хранить как исходный GDML файл, так и ROOT файл, полученный в результате процедуры импорта GDML и экспорта в ROOT.

% Таким образом, выполнена разработка модулей FairROOT для гибкой работы с форматом GDML, разработанные модули применены для обновления геометрии детектора RICH эксперимента CBM.
