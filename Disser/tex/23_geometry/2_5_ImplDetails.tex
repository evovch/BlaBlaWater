% ================================================================================================================
%  ___                 _                           _        _   _                     _      _        _ _     
% |_ _|_ __ ___  _ __ | | ___ _ __ ___   ___ _ __ | |_ __ _| |_(_) ___  _ __       __| | ___| |_ __ _(_) |___ 
%  | || '_ ` _ \| '_ \| |/ _ \ '_ ` _ \ / _ \ '_ \| __/ _` | __| |/ _ \| '_ \     / _` |/ _ \ __/ _` | | / __|
%  | || | | | | | |_) | |  __/ | | | | |  __/ | | | || (_| | |_| | (_) | | | |   | (_| |  __/ || (_| | | \__ \
% |___|_| |_| |_| .__/|_|\___|_| |_| |_|\___|_| |_|\__\__,_|\__|_|\___/|_| |_|    \__,_|\___|\__\__,_|_|_|___/
%               |_|                                                                                           
% ================================================================================================================

\subsection{Избранные подробности реализации ``CATIA-GDML geometry builder''}\label{sec:secImplDetails}

Каждый макрос ``Builder'' --- это VBA проект, который хранится в отдельном catvba файле. Проект состоит из трёх разделов --- элементы графического интерфейса (формы), модули и модули классов. Большинство макросов ``Builder'' написано в соответствии с идеологией структурного программирования, без применения классов, и разделение на модули выполнено из соображений читаемости кода. Обычно в отдельный модуль выносился функционал, объединённый некоторой задачей. Так, например, во многих макросах имеется модуль ``CommonDigitalString'' для продвинутой работы со строками, модуль ``Support'', в который объединены типовые процедуры типа создания осей, геометрических ограничений, формообразований позиционирования и др. В некоторых случаях естественным образом требовалось использовать классы. Так, например, был реализован класс матрицы с методами нахождения углов поворота, который использовался в \macroname{Primitive creator} и \macroname{CATIA2GDML} и более подробно описан в~\ref{sec:secMatrices}.

% ================================================================================================================
%  _____                                   _       _     _           
% | ____|_ ____   __      __   ____ _ _ __(_) __ _| |__ | | ___  ___ 
% |  _| | '_ \ \ / /      \ \ / / _` | '__| |/ _` | '_ \| |/ _ \/ __|
% | |___| | | \ V /   _    \ V / (_| | |  | | (_| | |_) | |  __/\__ \
% |_____|_| |_|\_/   (_)    \_/ \__,_|_|  |_|\__,_|_.__/|_|\___||___/
%                                                                    
% ================================================================================================================

\subsubsection{Переменные окружения}\label{sec:secBuilderEnv}

Для максимального сокрытия подробностей реализации от пользователей и минимизации их действий, ``CATIA-GDML geometry builder'' использует возможности CATIA~v5 по настройке окружения. Пакет поставляется с папкой CATSettings, которая должна быть указана как папка с настройками при конфигурировании окружения перед началом использования пакета. Инструкция по настройке поставляется вместе с ``Builder''. В настройках окружения помимо прочего определены переменные окружения, значения которых активно используются из кода макропрограмм. В первую очередь неоходимо задать переменную BuilderPath, в которой указывается путь к папке с ``Builder'', полученной тем или иным способом. Помимо того, что без настроенного окружения не будут работать некоторые макропрограммы, не будут работать и пользовательские панели инструментов ``CATIA-GDML geometry builder'' в CATIA. Поэтому настоятельно рекомендуется перед использованием пакета выполнить настройку.

% ================================================================================================================
%  __  __       _        _               
% |  \/  | __ _| |_ _ __(_) ___ ___  ___ 
% | |\/| |/ _` | __| '__| |/ __/ _ \/ __|
% | |  | | (_| | |_| |  | | (_|  __/\__ \
% |_|  |_|\__,_|\__|_|  |_|\___\___||___/
%                                        
% ================================================================================================================

\subsubsection{Работа с матрицами позиционирования в ``CATIA-GDML geometry builder''}\label{sec:secMatrices}

При создании иерархии оъёмов возникает необходимость задавать положение дочернего объёма в материнском, которое в GEANT/ROOT хранится в виде матрицы $4 \times 4$. Эта матрица легко разбивается на две компоненты --- сложный поворот в трёхмерном пространстве и параллельный сдвиг, выполняемый после поворотов. Есть несколько интуитивно понятных человеку способов задать поворот тела в некоторой неподвижной системе координат, которой в нашем случае является система координат материнского объёма. По причине простоты реализации и дружелюбности для пользователя в ``CATIA-GDML geometry builder'' позиционирование дочернего объёма в материнском выполняется с помощью трёх последовательных поворотов вокруг постоянных осей Z, Y и X с последующим параллельным переносом. Три угла поворота и три координаты сдвига

{\centering
$\alpha$ вокруг Z \\
$\beta$ вокруг Y \\
$\gamma$ вокруг X \\
$a$ вдоль X \\
$b$ вдоль Y \\
$c$ вдоль Z \\
}

однозначно задают матрицу позиционирования, которая рассчитывается как произведение

{\centering
$M = M_t \cdot M_X \cdot M_Y \cdot M_Z$ \\

\[
M_Z=
\begin{pmatrix}
cos(\alpha) & -sin(\alpha) & 0 & 0 \\
sin(\alpha) & cos(\alpha) & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1
\end{pmatrix}
\]

\[
M_Y=
\begin{pmatrix}
cos(\beta) & 0 & sin(\beta) & 0 \\
0 & 1 & 0 & 0 \\
-sin(\beta) & 0 & cos(\beta) & 0 \\
0 & 0 & 0 & 1
\end{pmatrix}
\]

\[
M_X=
\begin{pmatrix}
1 & 0 & 0 & 0 \\
0 & cos(\gamma) & -sin(\gamma) & 0 \\
0 & sin(\gamma) & cos(\gamma) & 0  \\
0 & 0 & 0 & 1
\end{pmatrix}
\]

\[
M_t=
\begin{pmatrix}
1 & 0 & 0 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 1 & 0 \\
a & b & c & 1
\end{pmatrix}
\]

}

Следует отметить, что $\alpha$, $\beta$ и $\gamma$ не являются углами Эйлера, которые задают повороты вокруг изменяемых осей.
