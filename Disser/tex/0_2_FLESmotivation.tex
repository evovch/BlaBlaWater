\section{Обработка сигнала с детектора}\label{sec:secSignalProcessing}

\textbf{Задача: дать общую картину --- детектор, передняя электроника, передающая электроника, ЭВМ. Затем указать, что вот типа электроника с внешним триггером, а вот самотриггирующаяся электроника. Далее переходим к free-running DAQ.}

Рассмотрим общую последовательноть обработки сигнала детектора частиц. Источником является некоторое детектирующее устройство (или просто детектор). В зависимости от типа детектируемых частиц и внешних условий --- радиационная среда, температура, частота регистрации --- это может быть фотодиод, фотоэлектронный умножитель (ФЭУ), полупроводниковый детектор, микроканальная пластина, газовый электронный умножитель, и т.д. Все эти детекторы обладают таким общим свойством, что выходной сигнал, несущий информацию о зарегистрированной частице, это относительно слабый токовый импульс. Для того, чтобы выполнять дальнейшую обработку этого сигнала в ЭВМ его необходимо оцифровать.
%, а для этого нередко приходится выполнять предварительное усиление.
В связи с этим обрабатывающую электронику условно можно разделить на переднюю и остальную. Основная задача передней электроники --- оцифровать выходной аналоговый сигнал детектирующего устройства, при необходимости предварительно его усилив и отфильтровав. Передача аналогового сигнала затруднена, поэтому его обработка и оцифровка обычно выполняется как можно ближе к месту, где этот сигнал выбрабатывается, т.е. непосредственно на детекторе. В простом случае последующие слои электроники концентрируют и передают оцифрованные сигналы со многих каналов передней электроники. В более сложном случае возможна какая-то аппаратная обработка оцифрованных сигналов, например архивация или фильтрация с целью уменьшения потока данных.

Разработан целый ряд подходов к оцифровке сигналов с детекторов. Каждый из них лучше всего подходит к определённому детектору, однако возможно применение методов, разработанных для одного детектора, для оцифровки сигналов с другого детектора. Перечислим лишь некоторые из них. Если не вдаваться в подробности реализации, можно выделить следующие способы: регистрация момента времени прихода фронта, регистрация амплитуды сигнала, непрерывное семплирование (ещё?). Практически всегда требуется регистрация момента времени прихода сигнала, поэтому широко применяются комбинации перечисленных способов --- регистрация амплитуды сигнала вместе с моментом времени прихода переднего фронта, регистрация моментов времени переднего и заднего фронтов без захвата амплитуды, регистрация момента времени переднего фронта и формирование ограниченного числа семплов после него.

Если необходимо предварительное усиление, то применяют один из двух типов усилителей --- зарядочувствительный усилитель либо ???. В силу устройства зарядочувствительный усилитель является также формирователем (шейпером). Любая электроника подвержена шумам, поэтому для подавления шумов сигнал обычно предварительно проходит фильтр нижних частот, эффективно отрезающий частоты выше некоторого значения. (Что-то сказать про шейпирование и его неизбежность и влияние на временные характеристики) Ещё один способ борьбы с шумами --- фильтрация по амплитуде, т.е. установление некоторого порога по напряжению, ниже которого сигнал игнорируется. 

\subsection{Бестриггерная передняя электроника}

Рассмотрим схему, когда аналоговый импульс с детектора обрабатывается электроникой, регистрирущей момент времени прихода переднего фронта. Любой сигнал переключается за некоторое ненулевое время, поэтому необходимо определить точку, обозначающую фронт. Для этого применяют дискриминатор --- прибор, вырабатывающий логический ``0'', когда входной сигнал ниже установленного порога, и логическую ``1'', когда входной сигнал выше установленного порога. Таким образом точка пересечения сигнала и порога это точка, условно обозначающая момент времени прихода сигнала. На выходе дискриминатора получается логический сигнал, который необходимо преобразовать в цифровой с помощью время-цифрового преобразователя. На выходе ВЦП уже будет цифровой сигнал, а не логический. Далее могут работать концентраторы данных и какие-то ещё платы, обеспечивающие приём данных в ЭВМ. Таким принимающим устройством может быть обычный сетевой интерфейс, работающий с Ethernet. В CBM это не так, поэтому нужен FLIB.

\subsection{}

Рассмотрим систему считывания и сбора данных ``традиционного'' эксперимента.

(Тут нужно обсудить и почитать ещё. Возможен ли такой сценарий, в наше время или в прошлом, когда триггер чисто аналоговый. То есть передняя электроника игнорирует сигнал до тех пор, пока не сработает схема совпадения с триггером. В той модели традиционного триггера, которую я себе сейчас представляю, входной сигнал обрабатывается непрерывно, но выпускается на выход из буфера только при наличии триггера. Вероятно, возможно и то и то, но вопрос в том, что реально используется, что более распространено.)

Каждый канал передней электроники имеет выходной буфер, куда по принципу FIFO складываются оцифрованные входные сигналы. В экспериментальной установке присутствуют дететоры, вырабатывающие триггер --- сигнал, который заводится (условно) на каждый канал считывания, и говорит о том, что произошло интересное событие, которое необходимо сохранить для последующей обработки. Данный подход имеет свои причины. Во-первых, до недавнего времени физические эксперименты не требовали высоких частот регистрации --- выполнение физической программы при относительно низких частотах первичного взаимодействия было осуществимо в разумные сроки. Во-вторых, многие регистрирующие приборы имеют заметное ``мёртвое время'' --- время, в течение которого прибор не может обрабатывать входные сигналы. Следовательно, если канал регистрирует ложный входной сигнал, велика вероятности того, что будет пропущен полезный сигнал.

С развитием электроники ``мёртвое время'' уменьшалось. Более того, возможность применения принципиально другой считывающей электроники, как например чисто временной канал, реализованный в ППВМ, для обработки сигналов с МА~ФЭУ в CBM~RICH, исследуемая в данной работе, позволяет на порядки снизить ``мёртвое время'' и повысить точность регистрации временной отметки в ущерб полноты информации.

(Сюда подмешивается секция 2.2)

В CBM планируется использование программного триггера. Это означает, что для того, чтобы принять решение, сохранять принятые данные или нет, необходимо выполнить полную реконструкцию события, включая реконструкцию треков, которая является высоко-затратной задачей. Рассматривается также возможность на определённых этапах работы установки использовать для выработки триггера частичную реконструкцию. Например исследуется возможность триггирования по результатам реконструкций треков только в MUCH, когда стоит задача поиска (такой-то частицы).

В ``традиционном'' эксперименте триггер может формроваться в результате логических операций над сигналами с нескольких детекторов, реализованных аппаратно. Такая логика работает за (масштаб времени). Реконструкция треков выполняется за гораздо большее время (на столько-то порядков выше). По этой причине необходимо иметь не только буфер в электронике --- его будет недостаточно. 

(Сказать о том, что нужно хорошо настраивать пороги.)

\subsection{FLES}\label{sec:secFLES}

Всё вместе привело к разработке аппаратно-программного комплекса, называемого системой отбора первого уровня --- First Level Event Selector (FLES).
Электроника бестриггерная, несколько уровней концентрации данных, многочисленные буферы, формирование срезов времени, построение интервалов и только после этого мы переходим к построению событий.

Для эксперимента CBM был выполнен оценочный расчёт. Отправная точка --- возможно сохранение 1~Гбайт/сек данных. Считается, что одно событие CBM в среднем имеет объём 40~Кбайт. Отсюда следует, что максимальная частота первичного взаимодействия может быть 25~кГц. В стартовой конфигурации CBM частота первичного взаимодействия равна 10~МГц, следовательно необходимо уменьшить поток данных в 400~раз. В полноценном режиме работы CBM ожидается 25~МГц, т.е. $ 25 \cdot 10^{6} \cdot 40 $ Кбайт = 1 Тбайт/сек. Планируется разбить этот поток в 1~Тбайт/сек на 1000 входных каналов FLES, каждый по 1~Гбайт/сек, передающихся по 10-Гбитным оптическим каналам связи. Один входной канал FLES соответствует одному ``входному узлу'' (input node, IN) --- ЭВМ с установленной платой FLIB. Все вычисления, необходимые для отбора данных будут осуществляться на так называемых ``вычислительных узлах'' (computing node, CN). Входные и вычислительные узлы объединены в компьютерную сеть посредством InfiniBand QDR, образуя уникальную распределённую вычислительную систему, называемую FLES. Вычислительная подсеть будет иметь приблизительно 60000 ядер.

Планируется также, что FLES сможет функционировать в особом режиме, когда для выполнения реконструкции с целью отбора данных для сохранения будет использоваться только часть входного потока. Это представляется возможным при работе эксперимента над некоторыми пунктами физической программы. Например, можно восстанавливать такую-то частицу только по трекам в MUCH. При этом система приёма работает в полную силу --- идёт приём со всех детекторов и никакие данные не выбрасываются до тех пор, пока не будет выполнена реконструкция по данным с MUCH. Если в результате реконструкции выясняется, что  принятая порция данных потенциально интересна, то она извлекается из буферов и записывается. Это позволяется снизить поток сохраняемых данных в ??? раз, что особенно актуально при экстремально высоких частотах взаимодействия.

(Картинка, где показана схема для частичного триггера, вроде бы от Вальтера)
