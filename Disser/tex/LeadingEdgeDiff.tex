\section{Обработка сигнала с детектора}\label{sec:secSignalProcessing}

\textbf{Задача: дать общую картину --- детектор, передняя электроника, передающая электроника, ЭВМ. Затем указать, что вот типа электроника с внешним триггером, а вот самотриггирующаяся электроника. Далее переходим к free-running DAQ.}

Рассмотрим общую последовательноть обработки сигнала детектора частиц. Источником является некоторое детектирующее устройство (или просто детектор). В зависимости от типа детектируемых частиц и внешних условий --- радиационная среда, температура, частота регистрации --- это может быть фотодиод, фотоэлектронный умножитель (ФЭУ), полупроводниковый детектор, микроканальная пластина, газовый электронный умножитель, и т.д. Все эти детекторы обладают таким общим свойством, что выходной сигнал, несущий информацию о зарегистрированной частице, это относительно слабый токовый импульс. Для того, чтобы выполнять дальнейшую обработку этого сигнала в ЭВМ его необходимо оцифровать.
%, а для этого нередко приходится выполнять предварительное усиление.
В связи с этим обрабатывающую электронику условно можно разделить на переднюю и остальную. Основная задача передней электроники --- оцифровать выходной аналоговый сигнал детектирующего устройства, при необходимости предварительно его усилив и отфильтровав. Передача аналогового сигнала затруднена, поэтому его обработка и оцифровка обычно выполняется как можно ближе к месту, где этот сигнал выбрабатывается, т.е. непосредственно на детекторе. В простом случае последующие слои электроники концентрируют и передают оцифрованные сигналы со многих каналов передней электроники. В более сложном случае возможна какая-то аппаратная обработка оцифрованных сигналов, например архивация или фильтрация с целью уменьшения потока данных.

Разработан целый ряд подходов к оцифровке сигналов с детекторов. Каждый из них лучше всего подходит к определённому детектору, однако возможно применение методов, разработанных для одного детектора, для оцифровки сигналов с другого детектора. Перечислим лишь некоторые из них. Если не вдаваться в подробности реализации, можно выделить следующие способы: регистрация момента времени прихода фронта, регистрация амплитуды сигнала, непрерывное семплирование (ещё?). Практически всегда требуется регистрация момента времени прихода сигнала, поэтому широко применяются комбинации перечисленных способов --- регистрация амплитуды сигнала вместе с моментом времени прихода переднего фронта, регистрация моментов времени переднего и заднего фронтов без захвата амплитуды, регистрация момента времени переднего фронта и формирование ограниченного числа семплов после него.

Если необходимо предварительное усиление, то применяют один из двух типов усилителей --- зарядочувствительный усилитель либо ???. В силу устройства зарядочувствительный усилитель является также формирователем (шейпером). Любая электроника подвержена шумам, поэтому для подавления шумов сигнал обычно предварительно проходит фильтр нижних частот, эффективно отрезающий частоты выше некоторого значения. (Что-то сказать про шейпирование и его неизбежность и влияние на временные характеристики) Ещё один способ борьбы с шумами --- фильтрация по амплитуде, т.е. установление некоторого порога по напряжению, ниже которого сигнал игнорируется. 

\subsection{Бестриггерная передняя электроника}

Рассмотрим схему, когда аналоговый импульс с детектора обрабатывается электроникой, регистрирущей момент времени прихода переднего фронта. Любой сигнал переключается за некоторое ненулевое время, поэтому необходимо определить точку, обозначающую фронт. Для этого применяют дискриминатор --- прибор, вырабатывающий логический ``0'', когда входной сигнал ниже установленного порога, и логическую ``1'', когда входной сигнал выше установленного порога. Таким образом точка пересечения сигнала и порога это точка, условно обозначающая момент времени прихода сигнала. На выходе дискриминатора получается логический сигнал, который необходимо преобразовать в цифровой с помощью время-цифрового преобразователя. На выходе ВЦП уже будет цифровой сигнал, а не логический. Далее могут работать концентраторы данных и какие-то ещё платы, обеспечивающие приём данных в ЭВМ. Таким принимающим устройством может быть обычный сетевой интерфейс, работающий с Ethernet. В CBM это не так, поэтому нужен FLIB.

\subsection{}

Рассмотрим систему считывания и сбора данных ``традиционного'' эксперимента.

(Тут нужно обсудить и почитать ещё. Возможен ли такой сценарий, в наше время или в прошлом, когда триггер чисто аналоговый. То есть передняя электроника игнорирует сигнал до тех пор, пока не сработает схема совпадения с триггером. В той модели традиционного триггера, которую я себе сейчас представляю, входной сигнал обрабатывается непрерывно, но выпускается на выход из буфера только при наличии триггера. Вероятно, возможно и то и то, но вопрос в том, что реально используется, что более распространено.)

Каждый канал передней электроники имеет выходной буфер, куда по принципу FIFO складываются оцифрованные входные сигналы. В экспериментальной установке присутствуют дететоры, вырабатывающие триггер --- сигнал, который заводится (условно) на каждый канал считывания, и говорит о том, что произошло интересное событие, которое необходимо сохранить для последующей обработки. Данный подход имеет свои причины. Во-первых, до недавнего времени физические эксперименты не требовали высоких частот регистрации --- выполнение физической программы при относительно низких частотах первичного взаимодействия было осуществимо в разумные сроки. Во-вторых, многие регистрирующие приборы имеют заметное ``мёртвое время'' --- время, в течение которого прибор не может обрабатывать входные сигналы. Следовательно, если канал регистрирует ложный входной сигнал, велика вероятности того, что будет пропущен полезный сигнал.

С развитием электроники ``мёртвое время'' уменьшалось. Более того, возможность применения принципиально другой считывающей электроники, как например чисто временной канал, реализованный в ППВМ, для обработки сигналов с МА~ФЭУ в CBM~RICH, исследуемая в данной работе, позволяет на порядки снизить ``мёртвое время'' и повысить точность регистрации временной отметки в ущерб полноты информации.

(Сюда подмешивается секция 2.2)

В CBM планируется использование программного триггера. Это означает, что для того, чтобы принять решение, сохранять принятые данные или нет, необходимо выполнить полную реконструкцию события, включая реконструкцию треков, которая является высоко-затратной задачей. Рассматривается также возможность на определённых этапах работы установки использовать для выработки триггера частичную реконструкцию. Например исследуется возможность триггирования по результатам реконструкций треков только в MUCH, когда стоит задача поиска (такой-то частицы).

В ``традиционном'' эксперименте триггер может формроваться в результате логических операций над сигналами с нескольких детекторов, реализованных аппаратно. Такая логика работает за (масштаб времени). Реконструкция треков выполняется за гораздо большее время (на столько-то порядков выше). По этой причине необходимо иметь не только буфер в электронике --- его будет недостаточно. 

(Сказать о том, что нужно хорошо настраивать пороги.)

\subsection{FLES}\label{sec:secFLES}

Всё вместе привело к разработке аппаратно-программного комплекса, называемого системой отбора первого уровня --- First Level Event Selector (FLES).
Электроника бестриггерная, несколько уровней концентрации данных, многочисленные буферы, формирование срезов времени, построение интервалов и только после этого мы переходим к построению событий.

Для эксперимента CBM был выполнен оценочный расчёт. Отправная точка --- возможно сохранение 1~Гбайт/сек данных. Считается, что одно событие CBM в среднем имеет объём 40~Кбайт. Отсюда следует, что максимальная частота первичного взаимодействия может быть 25~кГц. В стартовой конфигурации CBM частота первичного взаимодействия равна 10~МГц, следовательно необходимо уменьшить поток данных в 400~раз. В полноценном режиме работы CBM ожидается 25~МГц, т.е. $ 25 \cdot 10^{6} \cdot 40 $ Кбайт = 1 Тбайт/сек. Планируется разбить этот поток в 1~Тбайт/сек на 1000 входных каналов FLES, каждый по 1~Гбайт/сек, передающихся по 10-Гбитным оптическим каналам связи. Один входной канал FLES соответствует одному ``входному узлу'' (input node, IN) --- ЭВМ с установленной платой FLIB. Все вычисления, необходимые для отбора данных будут осуществляться на так называемых ``вычислительных узлах'' (computing node, CN). Входные и вычислительные узлы объединены в компьютерную сеть посредством InfiniBand QDR, образуя уникальную распределённую вычислительную систему, называемую FLES. Вычислительная подсеть будет иметь приблизительно 60000 ядер.

Планируется также, что FLES сможет функционировать в особом режиме, когда для выполнения реконструкции с целью отбора данных для сохранения будет использоваться только часть входного потока. Это представляется возможным при работе эксперимента над некоторыми пунктами физической программы. Например, можно восстанавливать такую-то частицу только по трекам в MUCH. При этом система приёма работает в полную силу --- идёт приём со всех детекторов и никакие данные не выбрасываются до тех пор, пока не будет выполнена реконструкция по данным с MUCH. Если в результате реконструкции выясняется, что  принятая порция данных потенциально интересна, то она извлекается из буферов и записывается. Это позволяется снизить поток сохраняемых данных в ??? раз, что особенно актуально при экстремально высоких частотах взаимодействия.

(Картинка, где показана схема для частичного триггера, вроде бы от Вальтера)



\subsection{Построение события}\label{sec:secEventBuilding}

Тот факт, что физическая программа эксперимента CBM подразумевает исследование очень редких явлений, для которых практически невозможно вырабатывать аппаратный триггер, привёл к решению разработать и использовать бестриггерную систему считывания. В бестриггерной системе считывания каждый канал передней электроники вырабатывает сообщение при преодолении входным аналоговым сигналом установленного порога. Получается, что электроника выдаёт для программного обеспечения непрерывный поток никак не сгруппированных сообщений, содержащих временную отметку. Для того, чтобы выполнять физический анализ, необходимо в этом непрерывном потоке выделять осмысленные группы, которые мы называем событиями. Строго говоря, задача построения событий --- это одномерная задача кластеризации на оси времени с последующим отбором кластеров по некоторым критериям.

Задача также усложнена тем фактом, что электроника не может обеспечить непрерывный поток сообщений, упорядоченных по времени регистрации. Происходит группировка сообщений в так называемые DAQ-события, которые необходимы для обеспечения передачи информации, а сообщения внутри DAQ-событий могут быть упорядочны произвольно. Соответственно первый этап построения события --- упорядочивание сообщений.

В данных с пучковых тестов 2014~г., для того, чтобы определить, является ли распознанная группа событием, можно использовать сигналы с детекторов пучка --- пороговых черенковских счётчиков, годоскопов и др. В лабораторных данных, где выполнялись измерения с лазером, в качестве триггера можно использовать сигнал от генератора, управляющего лазером. В ситуации, когда нет дополнительной информации, как в случае полного детектора RICH в итоговом эксперименте, необходимо принимать решение о том, является распознанная группа событием, или нет, на основе исключительно информации, полученной из этой группы. Распознанный кластер может являться событием, но чаще всего будет состоять из одного сообщения --- шумового хита. Следовательно можно использовать кол-во хитов в событии для подавления шумов, что особенно актуально для дететора CBM~RICH, где выполняется реконструкция черенковских колец, требующая некоторого минимального числа хитов в плоскости реконструкции.

(Сначала общая идея, что в любом случае будет некоторое временное окно и все сообщения попадающие в окно формируют событие. Размеры окна --- один из параметров построителя событий, которым можно играть с целью повышения эффективности.)

(А здесь можно описать предлагаемый алгоритм)

\subsection{LeadingEdgeDiff}\label{sec:secLeadingEdgeDiff}

Один из этапов обработки данных --- построение событий. В данной работе рассматривается два типа событий --- сигналы от лазера и сигналы от черенковского кольца. В любом случае, событие --- это структура данных, содержащая информацию о хитах, сгруппированных по времени. Каждый хит содержит, как минимум, временную отметку момента прихода переднего фронта сигнала и номер канала, который в случае CBM~RICH указывает номер пикселя фоточувствительной камеры, т.е. говорит о геометрическом положений зарегистрированного фотона.

Данное исследование посвящено, в первую очередь, временным характеристикам системы считывания, поэтому в основном речь пойдёт о временных отметках.

Очевидно, что для каждого события можно построить несколько распределений, которые на большом массиве данных, т.е. на многих событиях, характеризуют систему считывания и могут быть использованы для калибровки электроники с целью повышения временного разрешения системы. Т.к. событие имеет максимальную ширину, определяемую размерами окна в алгоритме построения событий, распределения могут иметь ``обрезанные хвосты'', которые, однако, невозможно избежать.

Пусть событие содержит N хитов. Введём внутри события нумерацию хитов от 0 до N. Пусть внутри события хиты упорядочены по времени, т.е. хит с временной отметкой $ t_{0} $ был зарегистрирован раньше остальных, а хит с временной отметкой $ t_{N} $ --- позже всех. Такой порядок может, например, обеспечиваться естественным образом алгоритмом построения событий. Внутри события все временные отметки зарегистрированы в разных каналах --- множественные хиты в одном канале в одном событий являются признаком того, что порог дискриминатора установлен слишком низко и регистрируются шумы. Введём в рассмотрение распределение $ \omega $ разностей временных отметок всех хитов, кроме первого, относительно первого, т.е. распределение

{\centering
$ t_{j} - t_{0} $, где  $ j \in [1..N] $.\\
}

Также введём распределение $ \sigma_{1} $ всех пар временных отметок одного события, т.е.

{\centering
$ t_{j}-t_{i} $, где $ i \in [0..N], j \in [0..N], i \neq j $.\\
}

Очевидно, что в такой формулировке одна и та же пара временных отметок войдёт в распределение дважды с разными знаками --- например, $ t_{1}-t_{2} $ и $ t_{2}-t_{1} = -(t_{1}-t_{2}) $. Это делает распределение симметричным, среднее значение строго равно 0, а ширина распределения чуть больше, чем в случае, когда нет дублирования информации. Введём непрерывную нумерацию каналов и примем, что в разности $ t_{j}-t_{i} $ первая временная отметка была зарегистрирована каналом $a$, а вторая --- каналом $b$. Введём распределение $ \sigma_{2} $, по сути очень похожее на $ \sigma_{1} $, но без дублирования информации, в котором будем учитывать только пары, у которых $ b > a $.

В идеальной ситуации, если событие соответствует одной вспышке лазера или одному черенковскому кольцу, и отсутствуют факторы, размывающие время регистрации, все разницы были бы равны нулю. В качестве таких размывающих факторов можно привести, например, следующие: временные характеристики лазера, разброс геометрических путей черенковских фотонов, разброс времени прохождения электронной лавины в динодной системе ФЭУ, дребезг сигналов в передней электронике. Из-за перечисленных явлений распределение $ \omega $ имеет следующую форму --- (описание). Распределение $ \sigma_{2} $ --- (описание).

%Распределение $ \sigma_{2} $ позволяет определить относительную задержку распространения сигнала,
%Влияние всех этих явлений выливается в то, что распределение $ \sigma $ имеет колоколообразную форму.

Среднее значение либо положение масимума распределения $ \sigma_{2} $ можно использовать для того, чтобы определить значение поправки для данной пары каналов. Если выполнить анализ с применением коррекций, то вид всех распределений изменится. $ \omega $ сгруппируется ближе к нулю, $ \sigma_{2} $ передвинется к нулю, а $ \sigma_{1} $ сузится к нулю.

Представляется возможность анализировать различные области фоточувствительной камеры. Интересно группировать хиты в соответствии с тем, какой электроникой они обрабатываются. В данном анализе было введено 4 подмножества: 1~пара каналов, 16~каналов одной платы передней электроники, 64~канала одного МА~ФЭУ, 256~каналов 4~МА~ФЭУ, образующих площадку 2х2~МА~ФЭУ в одном углу камеры. При том, что вся фоточувствительная камера на пучковых тестах имела размер 4х4~МА~ФЭУ, рассматривать более 4~МА~ФЭУ одновременно не имеет смысла, т.к. в прототипе были установлены различные модели МА~ФЭУ, некоторые покрытые сместителем спектра, а некоторые нет.

